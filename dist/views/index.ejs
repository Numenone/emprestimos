<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Biblioteca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <h1>Biblioteca Digital</h1>

    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success"><%= success %></div>
    <% } %>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger">
        <% if (typeof error === 'string') { %><%= error %><% } else { %>Erro ao processar requisição<% } %>
      </div>
    <% } %>

    <!-- Seção de Alunos -->
    <section>
      <h2>Cadastrar Aluno</h2>
      <form id="alunoForm" action="/alunos" method="POST">
        <input type="text" name="nome" placeholder="Nome" required>
        <input type="email" name="email" placeholder="E-mail" required>
        <input type="text" name="matricula" placeholder="Matrícula" required>
        <button type="submit">Cadastrar</button>
      </form>

      <h3>Alunos Cadastrados</h3>
      <% if (alunos && alunos.length > 0) { %>
        <table>
          <thead>
            <tr><th>Nome</th><th>E-mail</th><th>Ações</th></tr>
          </thead>
          <tbody>
            <% alunos.forEach(aluno => { %>
              <tr>
                <td><%= aluno.nome %></td>
                <td><%= aluno.email %></td>
                <td>
                  <form action="/alunos/<%= aluno.id %>/email" method="POST" style="display: inline;">
                    <button type="submit">Enviar E-mail</button>
                  </form>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      <% } else { %><p>Nenhum aluno cadastrado.</p><% } %>
    </section>

    <!-- Seção de Livros -->
    <section>
      <h2>Cadastrar Livro</h2>
      <form id="livroForm" action="/livros" method="POST">
        <input type="text" name="titulo" placeholder="Título" required>
        <input type="text" name="autor" placeholder="Autor" required>
        <input type="number" name="quantidade" placeholder="Quantidade" min="1" required>
        <button type="submit">Cadastrar</button>
      </form>

      <h3>Livros Cadastrados</h3>
      <% if (livros && livros.length > 0) { %>
        <table>
          <thead>
            <tr><th>Título</th><th>Autor</th><th>Quantidade</th><th>Ações</th></tr>
          </thead>
          <tbody>
            <% livros.forEach(livro => { %>
              <tr>
                <td><%= livro.titulo %></td>
                <td><%= livro.autor %></td>
                <td><%= livro.quantidade %></td>
                <td>
                  <!-- Botão que abre o modal (ver abaixo, continua JavaScript para modal) -->
                  <button type="button" onclick='openEditModal(<%= livro.id %>, "<%- livro.titulo %>", "<%- livro.autor %>", <%= livro.quantidade %>)'>Editar</button>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      <% } else { %><p>Nenhum livro cadastrado.</p><% } %>
    </section>

    <!-- Seção de Empréstimos -->
    <section>
      <h2>Registrar Empréstimo</h2>
      <form id="emprestimoForm" action="/emprestimos" method="POST">
        <select name="alunoId" required>
          <option value="">Selecione um aluno</option>
          <% alunos && alunos.forEach(aluno => { %>
            <option value="<%= aluno.id %>"><%= aluno.nome %></option>
          <% }); %>
        </select>
        <select name="livroId" required>
          <option value="">Selecione um livro</option>
          <% livros && livros.forEach(livro => { %>
            <option value="<%= livro.id %>"><%= livro.titulo %></option>
          <% }); %>
        </select>
        <input type="date" name="dataDevolucao" required>
        <button type="submit">Registrar</button>
      </form>

      <h3>Empréstimos Ativos</h3>
      <% if (emprestimos && emprestimos.length > 0) { %>
        <table>
          <thead>
            <tr><th>Aluno</th><th>Livro</th><th>Data Devolução</th><th>Ações</th></tr>
          </thead>
          <tbody>
            <% emprestimos.forEach(emp => { %>
              <tr>
                <td><%= emp.aluno?.nome %></td>
                <td><%= emp.livro?.titulo %></td>
                <td><%= new Date(emp.dataDevolucao).toLocaleDateString('pt-BR') %></td>
                <td>
                  <form action="/emprestimos/<%= emp.id %>/devolver" method="POST">
                    <button type="submit">Devolver</button>
                  </form>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      <% } else { %><p>Nenhum empréstimo ativo no momento.</p><% } %>
    </section>

    <!-- Modal de Edição de Livro -->
    <div id="editModal" class="modal" role="dialog" aria-modal="true" style="display:none;">
      <div class="modal-content">
        <span class="close" style="cursor:pointer;">&times;</span>
        <h2>Editar Livro</h2>
        <form id="editLivroForm" action="/livros/0?_method=PUT" method="POST">
          <!-- Necessário para que Express entenda PUT -->
          <input type="hidden" name="_method" value="PUT">
          <input type="hidden" id="editLivroId" name="id">
          <input type="text" id="editTitulo" name="titulo" placeholder="Título" required>
          <input type="text" id="editAutor" name="autor" placeholder="Autor" required>
          <input type="number" id="editQuantidade" name="quantidade" placeholder="Quantidade" min="1" required>
          <button type="submit">Salvar Alterações</button>
        </form>
      </div>
    </div>

    <!-- Scripts para controle do modal (somente para UX, não interfere no submit) -->
    <script>
       const modal = document.getElementById("editModal");
  const span = modal.querySelector(".close");
  const editForm = document.getElementById("editLivroForm");

  function openEditModal(id, titulo, autor, quantidade) {
    // Preencher os campos do formulário com os dados do livro
    document.getElementById("editLivroId").value = id;
    document.getElementById("editTitulo").value = titulo;
    document.getElementById("editAutor").value = autor;
    document.getElementById("editQuantidade").value = quantidade;

    // Atualizar o action do form com o ID correto
    editForm.action = `/livros/${id}?_method=PUT`;

    // Mostrar o modal
    modal.style.display = "block";
  }

  // Fechar o modal ao clicar no "X"
  span.onclick = () => {
    modal.style.display = "none";
  };

  // Fechar o modal ao pressionar a tecla "Esc"
  window.onkeydown = (event) => {
    if (event.key === "Escape") {
      modal.style.display = "none";
    }
  };

  // Fechar o modal ao clicar fora da área do modal
  window.onclick = (event) => {
    if (event.target === modal) {
      modal.style.display = "none";
    }
  };
  </script>
  </div>
</body>
</html>
